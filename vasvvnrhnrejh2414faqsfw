// ==UserScript==
// @name         AutoDonator Enhanced UI Dark + Extra mode + DarkOrange Inputs
// @namespace    http://tampermonkey.net/
// @version      2.2
// @description  –ê–≤—Ç–æ–¥–æ–Ω–∞—Ç: –æ—Å–Ω–æ–≤–Ω–æ–π + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º. –ü–æ–ª—è –≤–≤–æ–¥–∞ —Ç—ë–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–µ, extra-—Ä–µ–∂–∏–º —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏.
// @match        https://www.donationalerts.com/dashboard/activity-feed/donations
// @grant        GM_setValue
// @grant        GM_getValue
// ==/UserScript==

(function() {
    'use strict';

    /*****************************************
     * 1. –°—Ç–∏–ª–∏ –∞–∞–∞–∞
     *****************************************/
    const style = document.createElement('style');
    style.innerHTML = `
        body {
            font-family: sans-serif;
        }
        /* –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å */
        #autoDonatorPanel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background-color: rgba(20,20,20,0.95);
            color: #fff;
            padding: 15px;
            border: 2px solid #FFA500;
            border-radius: 8px;
            width: 400px;           /* –ù–∞—á–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
            font-size: 16px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transition: width 0.4s ease; /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —à–∏—Ä–∏–Ω—ã */
        }
        /* –ü—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ */
        #autoDonatorPanel.extended {
            width: 700px; /* –®–∏—Ä–∏–Ω–∞ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ */
        }
        #autoDonatorToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background-color: rgba(20,20,20,0.95);
            color: #FFA500;
            border: 2px solid #FFA500;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 36px;
            cursor: pointer;
            font-size: 20px;
            display: none;
        }
        #autoDonatorPanel h3 {
            margin: 0 0 10px;
            text-align: center;
            font-size: 18px;
        }
        #autoDonatorPanel button {
            padding: 5px 10px;
            margin: 5px 2px;
            border: none;
            border-radius: 4px;
            background-color: #FFA500;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #autoDonatorPanel button:hover {
            background-color: #afa;
        }
        #autoDonatorLog {
            border: 1px solid #FFA500;
            padding: 5px;
            height: 150px;
            overflow-y: auto;
            background-color: #111;
            font-family: monospace;
            font-size: 14px;
        }
        .log-line {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .log-line.visible {
            opacity: 1;
        }
        /* –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞–º—è—Ç–∏ (‚ôªÔ∏è) */
        #resetMessagesBtn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #FFA500;
            font-size: 18px;
            cursor: pointer;
        }
        #resetMessagesBtn:hover {
            color: #ffb733;
        }
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫ —Å–ª–µ–≤–∞ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç) */
        #extraFunctionsBlock {
            display: none;
            position: absolute;
            top: 0;
            right: 100%;           /* —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ–º –±–ª–æ–∫ —Å–ª–µ–≤–∞ –æ—Ç –ø–∞–Ω–µ–ª–∏ */
            margin-right: 20px;    /* –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ */
            border: 1px solid #FFF;
            padding: 10px;
            background-color: rgba(20,20,20,0.95);
            color: #fff;
        }
        /* –ö–æ–≥–¥–∞ –ø–∞–Ω–µ–ª—å –∏–º–µ–µ—Ç –∫–ª–∞—Å—Å .extended, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ */
        #autoDonatorPanel.extended #extraFunctionsBlock {
            display: block;
        }
        /* –¢—ë–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ (–≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–∏) */
        #autoDonatorPanel input[type="text"],
        #autoDonatorPanel input[type="number"],
        #autoDonatorPanel input[type="file"] {
            background-color: #7A3B00; /* —Ç—ë–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π */
            color: #fff;
            border: 1px solid #FFA500;
            margin-top: 3px;
            margin-bottom: 5px;
            padding: 3px;
        }
        #autoDonatorPanel input[type="text"]::placeholder {
            color: #ccc;
        }
    `;
    document.head.appendChild(style);

    /*****************************************
     * 2. –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º —Å—Ç–∞—Ç—É—Å–∞
     *****************************************/
    function createFileInput(labelText, id) {
        const container = document.createElement('div');
        container.style.marginBottom = '8px';

        const label = document.createElement('label');
        label.textContent = labelText;
        label.style.display = 'block';
        label.style.marginBottom = '2px';
        container.appendChild(label);

        const input = document.createElement('input');
        input.type = 'file';
        input.id = id;
        container.appendChild(input);

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞
        const status = document.createElement('span');
        status.id = "status_" + id;
        status.style.marginLeft = '10px';
        status.style.fontWeight = 'bold';
        status.textContent = "‚ùå –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ø–∞–º—è—Ç–∏";
        status.style.color = "red";
        container.appendChild(status);

        return container;
    }

    /*****************************************
     * 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
     *****************************************/
    const panel = document.createElement('div');
    panel.id = "autoDonatorPanel";
    panel.innerHTML = `
        <button id="resetMessagesBtn" title="–°–±—Ä–æ—Å –ø–∞–º—è—Ç–∏, –≤–æ–∑–≤—Ä–∞—Ç –∫ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏">‚ôªÔ∏è</button>
        <h3>–ê–≤—Ç–æ–¥–æ–Ω–∞—Ç–µ—Ä</h3>
    `;
    document.body.appendChild(panel);

    // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–∞–Ω–µ–ª–∏, –∫–æ–≥–¥–∞ –æ–Ω–∞ —Å–∫—Ä—ã—Ç–∞
    const toggleBtn = document.createElement('div');
    toggleBtn.id = "autoDonatorToggle";
    toggleBtn.textContent = "‚ò∞";
    document.body.appendChild(toggleBtn);

    /*****************************************
     * 4. –ü–æ–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (–Ω–∏–∫–Ω–µ–π–º—ã, —Å–æ–æ–±—â–µ–Ω–∏—è)
     *****************************************/
    panel.appendChild(createFileInput('–ù–∏–∫–Ω–µ–π–º—ã', 'nicknamesFile'));
    panel.appendChild(createFileInput('–°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –¥–æ–Ω–∞—Ç–æ–≤', 'messagesFile'));

    /*****************************************
     * 5. –ü–æ–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º)
     *****************************************/
    const delayContainer = document.createElement('div');
    delayContainer.style.marginBottom = '8px';
    delayContainer.innerHTML = `
        <label>–¢–∞–π–º–∏–Ω–≥ –∑–∞–ø—É—Å–∫–∞ (—Å–µ–∫):</label><br>
        <input type="number" id="minDelay" value="60" style="width:50px;"> –¥–æ
        <input type="number" id="maxDelay" value="300" style="width:50px;">
    `;
    panel.appendChild(delayContainer);

    /*****************************************
     * 6. –î–∏–∞–ø–∞–∑–æ–Ω—ã —Å—É–º–º (–æ—Å–Ω–æ–≤–Ω–æ–π)
     *****************************************/
    const rangesContainer = document.createElement('div');
    rangesContainer.style.marginBottom = '8px';
    rangesContainer.innerHTML = `<label>–î–∏–∞–ø–∞–∑–æ–Ω—ã (% –æ—Ç, –¥–æ):</label>`;
    panel.appendChild(rangesContainer);

    function createRangeRow(percent = '', from = '', to = '') {
        const row = document.createElement('div');
        row.style.marginBottom = '4px';
        row.innerHTML = `
            <input type="number" class="rangePercent" placeholder="%" value="${percent}" style="width:40px;">
            <input type="number" class="rangeFrom" placeholder="–æ—Ç" value="${from}" style="width:50px;">
            <input type="number" class="rangeTo" placeholder="–¥–æ" value="${to}" style="width:50px;">
            <button class="removeRange">‚ùå</button>
        `;
        row.querySelector('.removeRange').addEventListener('click', () => {
            rangesContainer.removeChild(row);
        });
        rangesContainer.appendChild(row);
    }
    createRangeRow();

    const addRangeBtn = document.createElement('button');
    addRangeBtn.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω';
    panel.appendChild(addRangeBtn);
    addRangeBtn.addEventListener('click', () => createRangeRow());

    /*****************************************
     * 7. –ö–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
     *****************************************/
    const customMsgContainer = document.createElement('div');
    customMsgContainer.style.marginBottom = '8px';
    customMsgContainer.innerHTML = `
        <label>–ö–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label><br>
        <input type="text" id="customMessage" style="width:90%;">
    `;
    panel.appendChild(customMsgContainer);

    /*****************************************
     * 8. –ë–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ (–æ—Å–Ω–æ–≤–Ω–æ–π)
     *****************************************/
    const btnContainer = document.createElement('div');
    btnContainer.style.textAlign = 'center';
    panel.appendChild(btnContainer);

    const startBtn = document.createElement('button');
    startBtn.textContent = '‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç';
    btnContainer.appendChild(startBtn);

    const customSendBtn = document.createElement('button');
    customSendBtn.textContent = 'üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–Ω–∞—Ç';
    btnContainer.appendChild(customSendBtn);

    const checkLinesBtn = document.createElement('button');
    checkLinesBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä–æ–∫–∏';
    btnContainer.appendChild(checkLinesBtn);

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
    btnContainer.appendChild(saveBtn);

    const hideBtn = document.createElement('button');
    hideBtn.textContent = '–°–∫—Ä—ã—Ç—å –º–µ–Ω—é';
    btnContainer.appendChild(hideBtn);

    // –ö–Ω–æ–ø–∫–∞ ¬´–î–æ–ø. —Ñ—É–Ω–∫—Ü–∏–∏¬ª (—Ä–∞—Å—à–∏—Ä—è–µ—Ç –ø–∞–Ω–µ–ª—å)
    const extraMenuBtn = document.createElement('button');
    extraMenuBtn.textContent = '–î–æ–ø. —Ñ—É–Ω–∫—Ü–∏–∏';
    btnContainer.appendChild(extraMenuBtn);

    /*****************************************
     * 9. –õ–æ–≥
     *****************************************/
    const logArea = document.createElement('div');
    logArea.id = 'autoDonatorLog';
    panel.appendChild(logArea);

    /*****************************************
     * 10. –î–æ–ø. –±–ª–æ–∫ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç, –ø—Ä–∏ extended –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è)
     *****************************************/
    const extraBlock = document.createElement('div');
    extraBlock.id = 'extraFunctionsBlock';
    extraBlock.innerHTML = `
       <h4>–î–æ–ø. —Ñ—É–Ω–∫—Ü–∏–∏</h4>
       <div style="margin-bottom:5px;">
         <label>–î–æ–ø. –ò–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫):</label><br>
         –û—Ç <input type="number" id="extraMin" value="120" style="width:60px;">
         –¥–æ <input type="number" id="extraMax" value="300" style="width:60px;">
       </div>
       <div style="margin-bottom:5px;">
         <label>–ù–∏–∫ –¥–æ–ø. —Ä–µ–∂–∏–º–∞:</label><br>
         <input type="text" id="extraNick" value="ExtraNick" style="width:120px;">
       </div>
       <div style="margin-bottom:5px;">
         <label>–§–∞–π–ª –¥–æ–ø. —Å–æ–æ–±—â–µ–Ω–∏–π:</label><br>
         <input type="file" id="extraFile">
       </div>
       <button id="extraStartBtn">–°—Ç–∞—Ä—Ç (–î–æ–ø. —Ä–µ–∂–∏–º)</button>
       <p style="font-size:12px;">(–£–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–æ: —É–¥–∞–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏)</p>
    `;
    panel.appendChild(extraBlock);

    /*****************************************
     * 11. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
     *****************************************/
    let autoRunning = false, autoTimeout = null;
    let nicknamesData = [], messagesData = [];

    // –î–æ–ø. —Ä–µ–∂–∏–º
    let extraRunning = false, extraTimeout = null;
    let extraMessages = [], extraIndex = 0;

    /*****************************************
     * 12. –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞
     *****************************************/
    function updateStatusIndicator(inputId, isSaved) {
        const statusEl = document.getElementById("status_" + inputId);
        if (statusEl) {
            if (isSaved) {
                statusEl.textContent = "‚úÖ –£–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ø–∞–º—è—Ç–∏";
                statusEl.style.color = "green";
            } else {
                statusEl.textContent = "‚ùå –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ø–∞–º—è—Ç–∏";
                statusEl.style.color = "red";
            }
        }
    }

    /*****************************************
     * 13. –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
     *****************************************/
    function logMessage(msg) {
        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.className = 'log-line';
        line.textContent = `[${time}] ‚Äî ${msg}`;
        if (msg.includes('–û–∂–∏–¥–∞–Ω–∏–µ')) {
            line.style.color = 'yellow';
        } else if (msg.includes('–î–æ–Ω–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω')) {
            line.style.color = 'lightgreen';
        } else if (msg.includes('–û—à–∏–±–∫–∞')) {
            line.style.color = 'red';
        } else {
            line.style.color = 'white';
        }
        logArea.appendChild(line);
        setTimeout(() => line.classList.add('visible'), 10);
        logArea.scrollTop = logArea.scrollHeight;
    }

    /*****************************************
     * 14. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
     *****************************************/
    function loadFile(inputEl, callback) {
        const file = inputEl.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => callback(e.target.result);
        reader.readAsText(file, 'utf-8');
    }
    function loadNicknames() {
        loadFile(document.getElementById('nicknamesFile'), text => {
            nicknamesData = text.split('\n').map(s => s.trim()).filter(Boolean);
            GM_setValue('nicknamesMemory', nicknamesData);
            logMessage(`–ù–∏–∫–Ω–µ–π–º—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${nicknamesData.length}`);
            updateStatusIndicator('nicknamesFile', true);
        });
    }
    function loadMessages() {
        loadFile(document.getElementById('messagesFile'), text => {
            messagesData = text.split('\n').map(s => s.trim()).filter(Boolean);
            GM_setValue('messagesMemory', messagesData);
            logMessage(`–°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${messagesData.length}`);
            updateStatusIndicator('messagesFile', true);
        });
    }
    document.getElementById('nicknamesFile').addEventListener('change', loadNicknames);
    document.getElementById('messagesFile').addEventListener('change', loadMessages);

    // –î–æ–ø. —Ñ–∞–π–ª
    function loadExtraMessages() {
        loadFile(document.getElementById('extraFile'), text => {
            extraMessages = text.split('\n').map(s => s.trim()).filter(Boolean);
            GM_setValue('extraMessagesMemory', extraMessages);
            extraIndex = 0;
            logMessage(`–î–æ–ø. —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${extraMessages.length}`);
        });
    }
    document.getElementById('extraFile').addEventListener('change', loadExtraMessages);

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–∞–º—è—Ç–∏
    const storedNicks = GM_getValue('nicknamesMemory', []);
    if (Array.isArray(storedNicks) && storedNicks.length > 0) {
        nicknamesData = storedNicks;
        logMessage(`üîÅ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∏–∫–Ω–µ–π–º–æ–≤: ${nicknamesData.length}`);
        updateStatusIndicator('nicknamesFile', true);
    } else {
        updateStatusIndicator('nicknamesFile', false);
    }
    const storedMsgs = GM_getValue('messagesMemory', []);
    if (Array.isArray(storedMsgs) && storedMsgs.length > 0) {
        messagesData = storedMsgs;
        logMessage(`üîÅ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messagesData.length}`);
        updateStatusIndicator('messagesFile', true);
    } else {
        updateStatusIndicator('messagesFile', false);
    }
    const storedExtra = GM_getValue('extraMessagesMemory', []);
    if (Array.isArray(storedExtra) && storedExtra.length > 0) {
        extraMessages = storedExtra;
        logMessage(`üîÅ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–æ–ø. —Å–æ–æ–±—â–µ–Ω–∏–π: ${extraMessages.length}`);
    }

    // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞–º—è—Ç–∏
    const resetBtn = document.getElementById('resetMessagesBtn');
    resetBtn.addEventListener('click', () => {
        GM_setValue('nicknamesMemory', []);
        GM_setValue('messagesMemory', []);
        GM_setValue('extraMessagesMemory', []);
        nicknamesData = [];
        messagesData = [];
        extraMessages = [];
        logMessage('‚ôªÔ∏è –ü–∞–º—è—Ç—å –Ω–∏–∫–Ω–µ–π–º–æ–≤, —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –¥–æ–ø. —Å–æ–æ–±—â–µ–Ω–∏–π —Å–±—Ä–æ—à–µ–Ω–∞.');
        updateStatusIndicator('nicknamesFile', false);
        updateStatusIndicator('messagesFile', false);
    });

    /*****************************************
     * 15. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
     *****************************************/
    function saveSettings() {
        const rows = rangesContainer.querySelectorAll('div');
        const ranges = [];
        rows.forEach(row => {
            ranges.push({
                percent: row.querySelector('.rangePercent').value,
                from: row.querySelector('.rangeFrom').value,
                to: row.querySelector('.rangeTo').value
            });
        });
        const settings = {
            minDelay: document.getElementById('minDelay').value,
            maxDelay: document.getElementById('maxDelay').value,
            customMessage: document.getElementById('customMessage').value,
            ranges
        };
        GM_setValue('autoDonatorSettings', settings);
        logMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
    }
    saveBtn.addEventListener('click', saveSettings);

    const savedSettings = GM_getValue('autoDonatorSettings', null);
    if (savedSettings) {
        document.getElementById('minDelay').value = savedSettings.minDelay || 60;
        document.getElementById('maxDelay').value = savedSettings.maxDelay || 300;
        document.getElementById('customMessage').value = savedSettings.customMessage || '';
        rangesContainer.innerHTML = '';
        if (savedSettings.ranges && savedSettings.ranges.length) {
            savedSettings.ranges.forEach(r => {
                createRangeRow(r.percent, r.from, r.to);
            });
        } else {
            createRangeRow();
        }
        logMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ø–∞–º—è—Ç–∏.');
    }

    /*****************************************
     * 16. –§—É–Ω–∫—Ü–∏–∏ pickWeightedAmount, getRandomItem
     *****************************************/
    function parseRanges() {
        const rows = rangesContainer.querySelectorAll('div');
        let total = 0;
        const result = [];
        rows.forEach(row => {
            const percent = parseInt(row.querySelector('.rangePercent').value);
            const from = parseInt(row.querySelector('.rangeFrom').value);
            const to = parseInt(row.querySelector('.rangeTo').value);
            if (!isNaN(percent) && !isNaN(from) && !isNaN(to)) {
                total += percent;
                result.push({ percent, from, to });
            }
        });
        if (total !== 100) {
            logMessage('‚ùå –°—É–º–º–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100');
            return null;
        }
        return result;
    }
    function pickWeightedAmount(ranges) {
        const r = Math.floor(Math.random() * 100) + 1;
        let total = 0;
        for (const { percent, from, to } of ranges) {
            total += percent;
            if (r <= total) {
                return Math.floor(Math.random() * (to - from + 1)) + from;
            }
        }
        return Math.floor(Math.random() * 500) + 1;
    }
    function getRandomItem(arr) {
        if (!arr || !arr.length) return null;
        const i = Math.floor(Math.random() * arr.length);
        return arr[i];
    }

    /*****************************************
     * 17. –û—Å–Ω–æ–≤–Ω–æ–π –∞–≤—Ç–æ–¥–æ–Ω–∞—Ç
     *****************************************/
    async function sendDonation(customMsg = null) {
        const ranges = parseRanges();
        if (!ranges) return;
        const donateBtn = document.querySelector('button.b-donations__btn');
        if (!donateBtn) {
            logMessage('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –¥–æ–Ω–∞—Ç–∞.');
            return;
        }
        donateBtn.click();
        await new Promise(r => setTimeout(r, 1000));

        let nickname = getRandomItem(nicknamesData) || "Anonymous";
        let message = customMsg;
        if (!message) {
            if (messagesData.length === 0) {
                logMessage('üö® –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!');
                return;
            }
            // –ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const idx = Math.floor(Math.random() * messagesData.length);
            message = messagesData[idx];
            messagesData.splice(idx, 1);
            GM_setValue('messagesMemory', messagesData);
        }
        const amount = pickWeightedAmount(ranges);

        const nicknameInput = document.querySelector('#add_donation input[type=text]');
        const amountInput = document.querySelectorAll('#add_donation input[type=text]')[1];
        const messageTextarea = document.querySelector('#add_donation textarea');
        if (nicknameInput && amountInput && messageTextarea) {
            nicknameInput.value = nickname;
            amountInput.value = amount;
            messageTextarea.value = message;
        } else {
            logMessage('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è –≤–≤–æ–¥–∞.');
            return;
        }
        const checkbox = document.querySelector('#add_donation label span.b-checkbox__pseudo');
        if (checkbox) checkbox.click();
        await new Promise(r => setTimeout(r, 500));

        const sendBtn = document.querySelector('#add_donation button.b-btn');
        if (sendBtn) {
            sendBtn.click();
            logMessage(`‚úÖ –î–æ–Ω–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\nüí¨ ${message}\nüí∞ ${amount}‚ÇΩ`);
        } else {
            logMessage('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–Ω–∞—Ç–∞.');
        }
    }

    function startAutoDonator() {
        autoRunning = true;
        const min = parseInt(document.getElementById('minDelay').value) || 60;
        const max = parseInt(document.getElementById('maxDelay').value) || 300;

        function loop() {
            if (!autoRunning) return;
            const delay = Math.floor(Math.random() * (max - min + 1)) + min;
            logMessage(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ ${delay}—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–æ–Ω–∞—Ç–∞...`);
            autoTimeout = setTimeout(async () => {
                await sendDonation();
                loop();
            }, delay * 1000);
        }
        loop();
    }
    startBtn.addEventListener('click', () => {
        if (autoRunning) {
            autoRunning = false;
            if (autoTimeout) clearTimeout(autoTimeout);
            startBtn.textContent = '‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç';
            logMessage('–ê–≤—Ç–æ–¥–æ–Ω–∞—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
        } else {
            autoRunning = true;
            startBtn.textContent = '‚è∏ –ü–∞—É–∑–∞';
            logMessage('–ê–≤—Ç–æ–¥–æ–Ω–∞—Ç –∑–∞–ø—É—â–µ–Ω.');
            startAutoDonator();
        }
    });

    customSendBtn.addEventListener('click', () => {
        const customMsg = document.getElementById('customMessage').value.trim();
        if (!customMsg) {
            logMessage('‚ö†Ô∏è –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
            return;
        }
        sendDonation(customMsg);
        document.getElementById('customMessage').value = '';
    });

    checkLinesBtn.addEventListener('click', () => {
        const remaining = messagesData.length;
        logMessage(`–û—Å—Ç–∞–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–π: ${remaining}`);

        const min = parseInt(document.getElementById('minDelay').value) || 60;
        const max = parseInt(document.getElementById('maxDelay').value) || 300;
        const avg = (min + max) / 2;
        const totalSec = remaining * avg;
        const hours = Math.floor(totalSec / 3600);
        const minutes = Math.floor((totalSec % 3600) / 60);
        logMessage(`–ü—Ä–∏–º–µ—Ä–Ω–æ —Ö–≤–∞—Ç–∏—Ç –Ω–∞ ${hours}—á ${minutes}–º –ø—Ä–∏ —Å—Ä–µ–¥–Ω–µ–º ~${Math.round(avg)}—Å.`);
    });

    // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
    hideBtn.addEventListener('click', () => {
        panel.style.display = 'none';
        toggleBtn.style.display = 'block';
    });
    toggleBtn.addEventListener('click', () => {
        panel.style.display = 'block';
        toggleBtn.style.display = 'none';
    });

    /*****************************************
     * 18. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
     *****************************************/
    let extended = false;
    extraMenuBtn.addEventListener('click', () => {
        extended = !extended;
        if (extended) {
            panel.classList.add('extended');
            logMessage("–ü–∞–Ω–µ–ª—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ (–¥–æ–ø. —Ñ—É–Ω–∫—Ü–∏–∏).");
        } else {
            panel.classList.remove('extended');
            logMessage("–î–æ–ø. —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∫—Ä—ã—Ç—ã (–ø–∞–Ω–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞—Å—å).");
        }
    });

    // –ü–æ–ª—è –∏ –∫–Ω–æ–ø–∫–∞ –≤ –¥–æ–ø. —Ä–µ–∂–∏–º–µ
    const extraMinInput = document.getElementById('extraMin');
    const extraMaxInput = document.getElementById('extraMax');
    const extraNickInput = document.getElementById('extraNick');
    const extraStartBtn = document.getElementById('extraStartBtn');

    async function sendExtraDonation() {
        const donateBtn = document.querySelector('button.b-donations__btn');
        if (!donateBtn) {
            logMessage('–î–æ–ø: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –¥–æ–Ω–∞—Ç–∞.');
            return;
        }
        donateBtn.click();
        await new Promise(r => setTimeout(r, 1000));

        // –ù–∏–∫
        const enick = extraNickInput.value.trim() || "ExtraNick";

        // –°–æ–æ–±—â–µ–Ω–∏–µ (–ø–æ –ø–æ—Ä—è–¥–∫—É, —É–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞)
        if (extraMessages.length === 0) {
            logMessage('–î–æ–ø: –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!');
            return;
        }
        const emessage = extraMessages[0]; // –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π
        extraMessages.splice(0, 1);          // —É–¥–∞–ª—è–µ–º –µ–≥–æ
        GM_setValue('extraMessagesMemory', extraMessages);

        // –°—É–º–º–∞ = random –∏–∑ extraMin..extraMax
        const emin = parseInt(extraMinInput.value) || 50;
        const emax = parseInt(extraMaxInput.value) || 100;
        const eamount = Math.floor(Math.random() * (emax - emin + 1)) + emin;

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
        const nicknameInput = document.querySelector('#add_donation input[type=text]');
        const amountInput = document.querySelectorAll('#add_donation input[type=text]')[1];
        const messageTextarea = document.querySelector('#add_donation textarea');
        if (nicknameInput && amountInput && messageTextarea) {
            nicknameInput.value = enick;
            amountInput.value = eamount;
            messageTextarea.value = emessage;
        } else {
            logMessage('–î–æ–ø: –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è –≤–≤–æ–¥–∞.');
            return;
        }
        const checkbox = document.querySelector('#add_donation label span.b-checkbox__pseudo');
        if (checkbox) checkbox.click();
        await new Promise(r => setTimeout(r, 500));

        const sendBtn = document.querySelector('#add_donation button.b-btn');
        if (sendBtn) {
            sendBtn.click();
            logMessage(`‚úÖ [–î–æ–ø] –î–æ–Ω–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\nüë§ ${enick}\nüí¨ ${emessage}\nüí∞ ${eamount}‚ÇΩ`);
        } else {
            logMessage('–î–æ–ø: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–Ω–∞—Ç–∞.');
        }
    }
    function startExtraLoop() {
        extraRunning = true;
        function loop() {
            if (!extraRunning) return;
            const emin = parseInt(extraMinInput.value) || 50;
            const emax = parseInt(extraMaxInput.value) || 100;
            const edelay = Math.floor(Math.random() * (emax - emin + 1)) + emin;
            logMessage(`‚è≥ [–î–æ–ø] –û–∂–∏–¥–∞–Ω–∏–µ ${edelay}—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–æ–ø. –¥–æ–Ω–∞—Ç–∞...`);
            extraTimeout = setTimeout(async () => {
                await sendExtraDonation();
                loop();
            }, edelay * 1000);
        }
        loop();
    }

    extraStartBtn.addEventListener('click', () => {
        if (extraRunning) {
            extraRunning = false;
            if (extraTimeout) clearTimeout(extraTimeout);
            extraStartBtn.textContent = '–°—Ç–∞—Ä—Ç (–î–æ–ø. —Ä–µ–∂–∏–º)';
            logMessage('–î–æ–ø. —Ä–µ–∂–∏–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
        } else {
            extraRunning = true;
            extraStartBtn.textContent = '–°—Ç–æ–ø (–î–æ–ø. —Ä–µ–∂–∏–º)';
            logMessage('–î–æ–ø. —Ä–µ–∂–∏–º –∑–∞–ø—É—â–µ–Ω.');
            startExtraLoop();
        }
    });

})();
